#!/usr/bin/env bash
source "$DOTFILES/sources/strict.bash"

# =====================================
# Checks

# check for support
if ! is-linux; then
	echo-style --notice="[$0] currently only supports Linux systems, skipping." >/dev/stderr
	exit 0
fi

# =====================================
# Action

# --paths
samba_config='/etc/samba/smb.conf'
samba_paths=(
	"$samba_config"
	'/etc/samba/'
)
if test "${1-}" = '--paths'; then
	echo-lines -- "${samba_paths[@]}"
	exit
fi

# install
env NAME='Samba' \
	APT='samba samba-common-bin' \
	setup-util
sudo systemctl disable smbd || :
sudo systemctl stop smbd || :

# ensure correct permissions
sudo mkdir -p /etc/samba/credentials/share
sudo chown root:root /etc/samba/credentials
sudo chmod 700 /etc/samba/credentials
sudo chmod 600 /etc/samba/credentials/share

# configure
if confirm-negative --ppid=$$ -- "Customise Samba configuration?"; then
	source "$DOTFILES/sources/edit.bash"
	sudo_edit "$samba_config"
fi

# verify configuration
testparm --suppress-prompt
