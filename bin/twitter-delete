#!/usr/bin/env bash
source "$DOTFILES/sources/strict.bash"

# dependencies
env QUIET=yes setup-util-jq

# currently blocked:
# https://github.com/twitter/twurl/issues/160

twitter-setup

if ruby --version | grep -qE '^ruby 3'; then
	cat <<-EOF >/dev/stderr
		twitter-delete requires twurl to run against ruby v2
		In your user source file, set the version: RUBY_VERSION='2.7'
		Then run setup-ruby and try again
	EOF
	exit 1
fi

function act {
	echo "Deleting: $tweet"
	# https://developer.twitter.com/en/docs/twitter-api/v1/tweets/post-and-engage/api-reference/post-statuses-destroy-id
	# https://developer.twitter.com/en/docs/labs/tweets-and-users/api-reference
	twurl -X POST "/1.1/statuses/destroy/$1.json"
	echo -e '\n'
}

# stdin
stdin="no"
while read -rt 1 tweet; do
	stdin="yes"
	act "$tweet"
done <&0

if test "$stdin" = "no"; then
	# invalid
	if test "$#" -eq 0; then
		cat <<-EOF >/dev/stderr
			USAGE:
			twitter-delete <...tweet>
			cat tweet.js | sed 's/window.YTD.tweet.part0 = //' | jq -r '.[].tweet.id_str' | twitter-delete
		EOF
		exit 1
	else
		for tweet in "$@"; do
			act "$tweet"
		done
	fi
fi
