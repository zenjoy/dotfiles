#!/usr/bin/env bash
source "$DOTFILES/sources/strict.bash"

# =====================================
# Checks

# check that an accident has not occured
if ! is-linux; then
	echo-style --notice="[$0] is only intended to be run on Linux systems, skipping." >/dev/stderr
	exit 0
fi

# check applicability
if test "${ACTION-}" = 'update' && command-missing snap; then
	echo-style --notice="[snap] is missing, and we are [update] only, skipping." >/dev/stderr
	exit 0
fi

# =====================================
# Start

echo-segment --h1='Setup Snap'

# =====================================
# Configuration

source "$DOTFILES/sources/config.bash"

# setup.bash provides:
SNAP_INSTALL=()
load_dotfiles_config 'setup.bash'

# adjustments
mapfile -t SNAP_INSTALL < <(prepare_packages 'SNAP_INSTALL' -- "${SNAP_INSTALL[@]}")

# =====================================
# Action

# https://wiki.manjaro.org/index.php/Snap
# https://packages.ubuntu.com/bionic/gnome/gnome-software-plugin-snap

env NAME='snap' CLI='snap' \
	DNF='snapd' \
	PAMAC='snapd' \
	setup-util

if ! systemctl status snapd.socket --no-pager >/dev/null; then
	sudo systemctl enable --now snapd.socket
fi

if test ! -d /snap; then
	sudo ln -s /var/lib/snapd/snap /snap
fi

if command-exists gnome-software; then
	# PAMAC='gnome-software-snap' \
	# Error: target not found: gnome-software-snap
	env NAME='Snap via Gnome Software' OPTIONAL=yes \
		APT='gnome-software-plugin-snap' \
		setup-util || :
fi

# snap update
sudo snap refresh

# =====================================
# Packages

function snap_install_bulk() {
	echo-segment --h2="Install $# snaps"
	if test "$#" -ne 0; then
		env CONFIRM= NAME="snap:$*" SNAP="$*" setup-util snap
	fi
	echo-segment --g2="Install $# snaps"
}

snap_install_bulk "${SNAP_INSTALL[@]}"

# configure with
# snap list --color=never | sed '1d' | cut -d' ' -f1 | grep --invert-match -E '^(core|snapd)'

# =====================================
# Finish

echo-segment --g1='Setup Snap'
