#!/usr/bin/env bash
source "$DOTFILES/sources/strict.bash"

# fresh macos without brew has no ping
function is_internet_working() {
	local option_url option_quiet log='/dev/null' connected='no'
	option_quiet="$(is-quiet -- "$@" || :)"
	option_url="$(get-flag-value hostname --missing="cloudflare.com" -- "$@")"

	# prepare body
	if test "$option_quiet" = 'no'; then
		log="$(mktemp)"
	fi

	# header
	if test "$option_quiet" != 'yes'; then
		echo-segment --h1='Verify Internet Connection'
	fi

	# check
	if command-exists ping; then
		if ping -c 1 "$option_url" &>"$log"; then
			connected='yes'
		fi
	elif command-exists whois; then
		if whois "$option_url" &>"$log"; then
			connected='yes'
		fi
	fi

	# body
	if test "$option_quiet" = 'no'; then
		echo-style --dim="$(cat "$log")"
	fi

	# footer
	if test "$connected" = 'yes'; then
		if test "$option_quiet" = 'no'; then
			echo-style --green="It appears you are connected to the internet."
		fi
		if test "$option_quiet" != 'yes'; then
			echo-segment --g1='Verify Internet Connection'
		fi
		return 0
	else
		if test "$option_quiet" != 'yes'; then
			echo-style --red="$(
				cat <<-EOF
					It appears you are disconnected from the internet.
					It could be a DNS issue in which [setup-dns] or [select-dns] may work.
				EOF
			)"
			echo-segment --e1='Verify Internet Connection'
		fi
		return 1
	fi
}

# fire if invoked standalone
if test "$0" = "${BASH_SOURCE[0]}"; then
	is_internet_working "$@"
fi
